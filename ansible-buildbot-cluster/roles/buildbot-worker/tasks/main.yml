---

- import_tasks: debian.yml
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

- import_tasks: centos.yml
  when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'

- name: Ensuring Docker is connectable via TCP
  replace:
    path: /lib/systemd/system/docker.service
    regexp: "dockerd -H fd://$"
    replace: "dockerd -H fd:// -H tcp://localhost:2375"
  become: yes
  notify: "Restart Docker"

- name: Create BuildBot user
  user:
    name: '{{ buildbot_user }}'
    password: "{{ lookup('password', '/dev/null encrypt=sha1_crypt length=32') }}"
    update_password: always
    home: "{{ buildbot_home }}"
    shell: /sbin/nologin
    groups: buildbot,docker
  become: yes
  when: create_buildbot_user

- name: Ensure BuildBot parent directory exists and has the right permissions
  file:
    state: directory
    path: "{{ buildbot_home }}"
    owner: "{{ buildbot_user }}"
    group: "{{ buildbot_user }}"
    recurse: yes
  become: yes

- name: Templating guest config files
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    force: yes
    owner: "{{ buildbot_user }}"
    group: "{{ buildbot_user }}"
    mode: 0755
  with_items:
    - { src: debsetup.sh, dest: "{{ buildbot_home }}/debsetup.sh" }
    - { src: centsetup.sh, dest: "{{ buildbot_home }}/centsetup.sh" }
  become: yes

- name: Creating ssh key copy directory
  file:
    path: "{{ buildbot_home }}/worker"
    state: directory
    owner: 1000
    group: 1000
    mode: 0750
  become: yes

- name: Creating copy of SSH keys with appropriate permissions for BuildBot
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    remote_src: yes
    owner: 1000 #Note: This is the hardcoded buildbot user inside the docker image, do not change this
    group: 1000
    mode: 0600
  with_items:
    - { src: "{{ buildbot_home }}/.ssh/id_rsa", dest: "{{ buildbot_home }}/worker/id_rsa" }
    - { src: "{{ buildbot_home }}/.ssh/id_rsa.pub", dest: "{{ buildbot_home }}/worker/id_rsa.pub" }
    - { src: "{{ buildbot_home }}/.ssh/known_hosts", dest: "{{ buildbot_home }}/worker/known_hosts" }
  become: yes
